name: Release and Build

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write
  actions: write
  packages: write

jobs:
  version-bump:
    name: Version Bump
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      new_tag: ${{ steps.version.outputs.new_tag }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: Install svu (Semantic Version Util)
      run: |
        go install github.com/caarlos0/svu@latest
        
    - name: Get current version
      id: current_version
      run: |
        # Get the latest tag, if no tags exist, start with v0.0.0
        CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
        echo "Current version: ${CURRENT_VERSION}"
        
    - name: Calculate next version
      id: version
      run: |
        # Use svu to calculate next version based on conventional commits
        NEXT_VERSION=$(svu next --strip-prefix)
        CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
        
        # If versions are the same, no version bump needed
        if [ "v${NEXT_VERSION}" = "${CURRENT_VERSION}" ]; then
          echo "No version bump needed"
          echo "new_version=" >> $GITHUB_OUTPUT
          echo "new_tag=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "new_version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
        echo "new_tag=v${NEXT_VERSION}" >> $GITHUB_OUTPUT
        echo "Next version: ${NEXT_VERSION}"
        
    - name: Create and push tag
      if: steps.version.outputs.new_version != ''
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
        git push origin "v${NEW_VERSION}"

  release:
    name: Release with GoReleaser
    runs-on: ubuntu-latest
    needs: version-bump
    if: needs.version-bump.outputs.new_version != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.version-bump.outputs.new_tag }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # Required for multi-arch Docker builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew tap
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          repository: theburrowhub/homebrew-tap
          event-type: update-formula
          client-payload: '{"formula": "git-gone", "version": "${{ needs.version-bump.outputs.new_tag }}"}'
